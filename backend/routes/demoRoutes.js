// backend/routes/demoRoutes.js - VEDIC PRACTICAL WISDOM APPROACH
const express = require('express');
const router = express.Router();

const PERPLEXITY_API_KEY = process.env.PERPLEXITY_API_KEY || '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';

router.post('/generate-demo-content', async (req, res) => {
    try {
        const { 
            name, 
            zodiacSign, 
            gender, 
            language = 'hindi',
            predictionType = 'daily_rashifal',
            type = 'vedic_prediction'
        } = req.body;
        
        if (!name || !zodiacSign) {
            return res.status(400).json({
                success: false,
                message: language === 'hindi' ? 'рдирд╛рдо рдФрд░ рд░рд╛рд╢рд┐ рдЖрд╡рд╢реНрдпрдХ рд╣реИрдВ' : 'Name and zodiac sign are required'
            });
        }

        // ЁЯОп DYNAMIC DATE GENERATION (Indian Time)
        const getCurrentIndianDate = () => {
            const now = new Date();
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                weekday: 'long',
                timeZone: 'Asia/Kolkata'
            };
            return {
                hindi: now.toLocaleDateString('hi-IN', options),
                english: now.toLocaleDateString('en-IN', options),
                weekday: now.toLocaleDateString('hi-IN', { weekday: 'long', timeZone: 'Asia/Kolkata' }),
                time: now.toLocaleTimeString('hi-IN', { timeZone: 'Asia/Kolkata', hour12: true })
            };
        };

        const today = getCurrentIndianDate();
        console.log("Today (Indian Time):", today);

        // ЁЯФо VEDIC ZODIAC INFORMATION WITH PRACTICAL WISDOM
        const getVedicRashiInfo = (zodiacSign) => {
    const vedicRashis = {
        'mesha': { 
            name: 'рдореЗрд╖', english: 'Aries', lord: 'рдордВрдЧрд▓', element: 'рдЕрдЧреНрдирд┐', 
            nature: 'рдЪрд░', luckyColor: 'рд▓рд╛рд▓', mantra: 'реР рдордВрдЧрд▓рд╛рдп рдирдордГ',
            bodyPart: 'рд╕рд┐рд░', gemstone: 'рдореВрдВрдЧрд╛', metal: 'рддрд╛рдВрдмрд╛',
            personality: 'рд╕рд╛рд╣рд╕реА, рдиреЗрддреГрддреНрд╡ рдЧреБрдг, рдЬрд▓реНрджрдмрд╛рдЬрд╝', 
            strengths: 'рдирд┐рд░реНрдгрд╛рдпрдХ, рдКрд░реНрдЬрд╛рд╡рд╛рди, рд╕реНрд╡рддрдВрддреНрд░',
            challenges: 'рдЧреБрд╕реНрд╕реИрд▓, рдЕрдзреАрд░, рдЖрд╡реЗрд╢рд╢реАрд▓',
            lifeLesson: 'рдзреИрд░реНрдп рдФрд░ рд╕рдВрдпрдо рд╕реАрдЦрдирд╛',
            direction: 'рдкреВрд░реНрд╡',
            luckyDay: 'рдордВрдЧрд▓рд╡рд╛рд░',
            luckyNumbers: [1, 8, 17, 26],
            deity: 'рднрдЧрд╡рд╛рди рд╣рдиреБрдорд╛рди',
            symbol: 'тЩИ'
        },
        'vrishabha': { 
            name: 'рд╡реГрд╖рдн', english: 'Taurus', lord: 'рд╢реБрдХреНрд░', element: 'рдкреГрдереНрд╡реА', 
            nature: 'рд╕реНрдерд┐рд░', luckyColor: 'рд╕рдлреЗрдж', mantra: 'реР рд╢реБрдХреНрд░рд╛рдп рдирдордГ',
            bodyPart: 'рдЧрд▓рд╛', gemstone: 'рд╣реАрд░рд╛', metal: 'рдЪрд╛рдВрджреА',
            personality: 'рд╕реНрдерд┐рд░, рд╡реНрдпрд╛рд╡рд╣рд╛рд░рд┐рдХ, рд╕реБрдВрджрд░рддрд╛ рдкреНрд░реЗрдореА', 
            strengths: 'рджреГрдврд╝, рд╡рд┐рд╢реНрд╡рд╕рдиреАрдп, рдХрд▓рд╛рддреНрдордХ',
            challenges: 'рдЬрд┐рджреНрджреА, рдЖрд▓рд╕реА, рднреМрддрд┐рдХрд╡рд╛рджреА',
            lifeLesson: 'рд▓рдЪреАрд▓рд╛рдкрди рдФрд░ рдЕрдиреБрдХреВрд▓рди',
            direction: 'рджрдХреНрд╖рд┐рдг-рдкреВрд░реНрд╡',
            luckyDay: 'рд╢реБрдХреНрд░рд╡рд╛рд░',
            luckyNumbers: [6, 15, 24, 33],
            deity: 'рдорд╛рддрд╛ рд▓рдХреНрд╖реНрдореА',
            symbol: 'тЩЙ'
        },
        'mithuna': { 
            name: 'рдорд┐рдереБрди', english: 'Gemini', lord: 'рдмреБрдз', element: 'рд╡рд╛рдпреБ', 
            nature: 'рджреНрд╡рд┐рд╕реНрд╡рднрд╛рд╡', luckyColor: 'рд╣рд░рд╛', mantra: 'реР рдмреБрдзрд╛рдп рдирдордГ',
            bodyPart: 'рдХрдВрдзреЗ', gemstone: 'рдкрдиреНрдирд╛', metal: 'рдкреАрддрд▓',
            personality: 'рдмреБрджреНрдзрд┐рдорд╛рди, рд╕рдВрд╡рд╛рджрдкреНрд░рд┐рдп, рдмрд╣реБрдореБрдЦреА', 
            strengths: 'рддреЗрдЬрд╝ рджрд┐рдорд╛рдЧ, рдЕрдиреБрдХреВрд▓рдирд╢реАрд▓, рдорд┐рд▓рдирд╕рд╛рд░',
            challenges: 'рдЕрд╕реНрдерд┐рд░, рднреНрд░рдорд┐рдд, рд╕рддрд╣реА',
            lifeLesson: 'рдЧрд╣рд░рд╛рдИ рдФрд░ рдПрдХрд╛рдЧреНрд░рддрд╛ рд╡рд┐рдХрд╕рд┐рдд рдХрд░рдирд╛',
            direction: 'рдЙрддреНрддрд░',
            luckyDay: 'рдмреБрдзрд╡рд╛рд░',
            luckyNumbers: [5, 14, 23, 32],
            deity: 'рднрдЧрд╡рд╛рди рд╡рд┐рд╖реНрдгреБ',
            symbol: 'тЩК'
        },
        'karka': { 
            name: 'рдХрд░реНрдХ', english: 'Cancer', lord: 'рдЪрдВрджреНрд░', element: 'рдЬрд▓', 
            nature: 'рдЪрд░', luckyColor: 'рд╕рдлреЗрдж', mantra: 'реР рдЪрдВрджреНрд░рд╛рдп рдирдордГ',
            bodyPart: 'рдЫрд╛рддреА', gemstone: 'рдореЛрддреА', metal: 'рдЪрд╛рдВрджреА',
            personality: 'рднрд╛рд╡реБрдХ, рдкрд░рд┐рд╡рд╛рд░рдкреНрд░реЗрдореА, рд╕рдВрд╡реЗрджрдирд╢реАрд▓', 
            strengths: 'рджрдпрд╛рд▓реБ, рд╕рд╣рд╛рдиреБрднреВрддрд┐рд╢реАрд▓, рд╕реБрд░рдХреНрд╖рд╛рдкреНрд░рд┐рдп',
            challenges: 'рдЕрддрд┐рд╕рдВрд╡реЗрджрдирд╢реАрд▓, рдореВрдбреА, рдЪрд┐рдВрддрд╛рдЧреНрд░рд╕реНрдд',
            lifeLesson: 'рднрд╛рд╡рдирд╛рддреНрдордХ рд╕рдВрддреБрд▓рди рдФрд░ рдЖрддреНрдорд╡рд┐рд╢реНрд╡рд╛рд╕',
            direction: 'рдЙрддреНрддрд░-рдкрд╢реНрдЪрд┐рдо',
            luckyDay: 'рд╕реЛрдорд╡рд╛рд░',
            luckyNumbers: [2, 7, 11, 16, 20, 29],
            deity: 'рднрдЧрд╡рд╛рди рд╢рд┐рд╡',
            symbol: 'тЩЛ'
        },
        'simha': { 
            name: 'рд╕рд┐рдВрд╣', english: 'Leo', lord: 'рд╕реВрд░реНрдп', element: 'рдЕрдЧреНрдирд┐', 
            nature: 'рд╕реНрдерд┐рд░', luckyColor: 'рд╕реБрдирд╣рд░рд╛', mantra: 'реР рд╕реВрд░реНрдпрд╛рдп рдирдордГ',
            bodyPart: 'рд╣реГрджрдп', gemstone: 'рдорд╛рдгрд┐рдХ', metal: 'рд╕реЛрдирд╛',
            personality: 'рдЧрд░реНрд╡реАрд▓рд╛, рдиреЗрддрд╛, рдЖрддреНрдорд╡рд┐рд╢реНрд╡рд╛рд╕реА', 
            strengths: 'рдЙрджрд╛рд░, рд░рдЪрдирд╛рддреНрдордХ, рдкреНрд░реЗрд░рдгрд╛рджрд╛рдпрдХ',
            challenges: 'рдЕрд╣рдВрдХрд╛рд░реА, рд╣рдареА, рдзреНрдпрд╛рди рдЪрд╛рд╣рдиреЗ рд╡рд╛рд▓рд╛',
            lifeLesson: 'рд╡рд┐рдирдореНрд░рддрд╛ рдФрд░ рд╕реЗрд╡рд╛ рднрд╛рд╡рдирд╛',
            direction: 'рдкреВрд░реНрд╡',
            luckyDay: 'рд░рд╡рд┐рд╡рд╛рд░',
            luckyNumbers: [1, 3, 10, 19, 28],
            deity: 'рднрдЧрд╡рд╛рди рд╕реВрд░реНрдп',
            symbol: 'тЩМ'
        },
        'kanya': { 
            name: 'рдХрдиреНрдпрд╛', english: 'Virgo', lord: 'рдмреБрдз', element: 'рдкреГрдереНрд╡реА', 
            nature: 'рджреНрд╡рд┐рд╕реНрд╡рднрд╛рд╡', luckyColor: 'рдиреАрд▓рд╛', mantra: 'реР рдмреБрдзрд╛рдп рдирдордГ',
            bodyPart: 'рдкреЗрдЯ', gemstone: 'рдкрдиреНрдирд╛', metal: 'рдкреАрддрд▓',
            personality: 'рд╡рд┐рд╢реНрд▓реЗрд╖рдХ, рд╡реНрдпрд╡рд╕реНрдерд┐рдд, рд╕реЗрд╡рд╛рднрд╛рд╡реА', 
            strengths: 'рд╕рдЯреАрдХ, рдореЗрд╣рдирддреА, рд╕реНрд╡рд╛рд╕реНрдереНрдп рд╕рдЪреЗрдд',
            challenges: 'рдЖрд▓реЛрдЪрдХ, рдЪрд┐рдВрддрд╛рдЧреНрд░рд╕реНрдд, рдкреВрд░реНрдгрддрд╛рд╡рд╛рджреА',
            lifeLesson: 'рд╕реНрд╡реАрдХрд╛рд░ рдХрд░рдирд╛ рдФрд░ рдкреНрд░рд╡рд╛рд╣ рдореЗрдВ рд░рд╣рдирд╛',
            direction: 'рдЙрддреНрддрд░',
            luckyDay: 'рдмреБрдзрд╡рд╛рд░',
            luckyNumbers: [5, 14, 23, 32],
            deity: 'рднрдЧрд╡рд╛рди рдЧрдгреЗрд╢',
            symbol: 'тЩН'
        },
        'tula': { 
            name: 'рддреБрд▓рд╛', english: 'Libra', lord: 'рд╢реБрдХреНрд░', element: 'рд╡рд╛рдпреБ', 
            nature: 'рдЪрд░', luckyColor: 'рдЧреБрд▓рд╛рдмреА', mantra: 'реР рд╢реБрдХреНрд░рд╛рдп рдирдордГ',
            bodyPart: 'рдХрдорд░', gemstone: 'рд╣реАрд░рд╛', metal: 'рдЪрд╛рдВрджреА',
            personality: 'рдиреНрдпрд╛рдпрдкреНрд░рд┐рдп, рд╕рдВрддреБрд▓рдирдХрд╛рд░реА, рдХреВрдЯрдиреАрддрд┐рдХ', 
            strengths: 'рдиреНрдпрд╛рдпрдкреНрд░рд┐рдп, рдХрд▓рд╛рдкреНрд░реЗрдореА, рдорд┐рд▓рдирд╕рд╛рд░',
            challenges: 'рдЕрдирд┐рд░реНрдгрд╛рдпрдХ, рдЖрд▓рд╕реА, рджреВрд╕рд░реЛрдВ рдкрд░ рдирд┐рд░реНрднрд░',
            lifeLesson: 'рд╕реНрд╡рдпрдВ рдХреЗ рдирд┐рд░реНрдгрдп рд▓реЗрдирд╛ рд╕реАрдЦрдирд╛',
            direction: 'рдкрд╢реНрдЪрд┐рдо',
            luckyDay: 'рд╢реБрдХреНрд░рд╡рд╛рд░',
            luckyNumbers: [6, 15, 24, 33],
            deity: 'рдорд╛рддрд╛ рджреБрд░реНрдЧрд╛',
            symbol: 'тЩО'
        },
        'vrishchika': { 
            name: 'рд╡реГрд╢реНрдЪрд┐рдХ', english: 'Scorpio', lord: 'рдордВрдЧрд▓', element: 'рдЬрд▓', 
            nature: 'рд╕реНрдерд┐рд░', luckyColor: 'рдореИрд░реВрди', mantra: 'реР рдордВрдЧрд▓рд╛рдп рдирдордГ',
            bodyPart: 'рдЧреБрдкреНрддрд╛рдВрдЧ', gemstone: 'рдореВрдВрдЧрд╛', metal: 'рддрд╛рдВрдмрд╛',
            personality: 'рд░рд╣рд╕реНрдпрдордп, рддреАрд╡реНрд░, рдкрд░рд┐рд╡рд░реНрддрдирдХрд╛рд░реА', 
            strengths: 'рджреГрдврд╝ рд╕рдВрдХрд▓реНрдкрд┐рдд, рдЬрд╛рд╕реВрд╕реА рдХреБрд╢рд▓, рд╡рдлрд╛рджрд╛рд░',
            challenges: 'рд╕рдВрджреЗрд╣рд╢реАрд▓, рдмрджрд▓рд╛ рд▓реЗрдиреЗ рд╡рд╛рд▓рд╛, рдЧреБрдкреНрдд',
            lifeLesson: 'рдХреНрд╖рдорд╛ рдФрд░ рд╡рд┐рд╢реНрд╡рд╛рд╕ рдХрд░рдирд╛ рд╕реАрдЦрдирд╛',
            direction: 'рджрдХреНрд╖рд┐рдг',
            luckyDay: 'рдордВрдЧрд▓рд╡рд╛рд░',
            luckyNumbers: [1, 8, 17, 26],
            deity: 'рднрдЧрд╡рд╛рди рднреИрд░рд╡',
            symbol: 'тЩП'
        },
        'dhanu': { 
            name: 'рдзрдиреБ', english: 'Sagittarius', lord: 'рдмреГрд╣рд╕реНрдкрддрд┐', element: 'рдЕрдЧреНрдирд┐', 
            nature: 'рджреНрд╡рд┐рд╕реНрд╡рднрд╛рд╡', luckyColor: 'рдкреАрд▓рд╛', mantra: 'реР рдмреГрд╣рд╕реНрдкрддрдпреЗ рдирдордГ',
            bodyPart: 'рдЬрд╛рдВрдШреЗрдВ', gemstone: 'рдкреБрдЦрд░рд╛рдЬ', metal: 'рд╕реЛрдирд╛',
            personality: 'рджрд╛рд░реНрд╢рдирд┐рдХ, рдпрд╛рддреНрд░рд╛ рдкреНрд░реЗрдореА, рд╕реНрд╡рддрдВрддреНрд░рддрд╛рдкреНрд░рд┐рдп', 
            strengths: 'рдЖрд╢рд╛рд╡рд╛рджреА, рдЬреНрдЮрд╛рдиреА, рд╕рд╛рд╣рд╕реА',
            challenges: 'рдЕрдзреАрд░, рдЕрддрд┐рдЖрддреНрдорд╡рд┐рд╢реНрд╡рд╛рд╕реА, рдлрдХреНрдХрдбрд╝',
            lifeLesson: 'рдзреИрд░реНрдп рдФрд░ рдЬрд┐рдореНрдореЗрджрд╛рд░реА рд╕реАрдЦрдирд╛',
            direction: 'рдЙрддреНрддрд░-рдкреВрд░реНрд╡',
            luckyDay: 'рдЧреБрд░реБрд╡рд╛рд░',
            luckyNumbers: [3, 9, 12, 21, 30],
            deity: 'рднрдЧрд╡рд╛рди рджрдХреНрд╖рд┐рдгрд╛рдореВрд░реНрддрд┐',
            symbol: 'тЩР'
        },
        'makara': { 
            name: 'рдордХрд░', english: 'Capricorn', lord: 'рд╢рдирд┐', element: 'рдкреГрдереНрд╡реА', 
            nature: 'рдЪрд░', luckyColor: 'рдХрд╛рд▓рд╛', mantra: 'реР рд╢рдиреИрд╢реНрдЪрд░рд╛рдп рдирдордГ',
            bodyPart: 'рдШреБрдЯрдиреЗ', gemstone: 'рдиреАрд▓рдо', metal: 'рд▓реЛрд╣рд╛',
            personality: 'рдЕрдиреБрд╢рд╛рд╕рд┐рдд, рдорд╣рддреНрд╡рд╛рдХрд╛рдВрдХреНрд╖реА, рд╡реНрдпрд╛рд╡рд╣рд╛рд░рд┐рдХ', 
            strengths: 'рдореЗрд╣рдирддреА, рдЬрд┐рдореНрдореЗрджрд╛рд░, рджреГрдврд╝рдкреНрд░рддрд┐рдЬреНрдЮ',
            challenges: 'рдХрдареЛрд░, рдирд┐рд░рд╛рд╢рд╛рд╡рд╛рджреА, рдЕрдХреЗрд▓рд╛рдкрди рдкрд╕рдВрдж',
            lifeLesson: 'рд▓рдЪреАрд▓рд╛рдкрди рдФрд░ рдЦреБрд╢реА рдЦреЛрдЬрдирд╛',
            direction: 'рджрдХреНрд╖рд┐рдг-рдкрд╢реНрдЪрд┐рдо',
            luckyDay: 'рд╢рдирд┐рд╡рд╛рд░',
            luckyNumbers: [8, 17, 26, 35],
            deity: 'рднрдЧрд╡рд╛рди рд╢рдирд┐',
            symbol: 'тЩС'
        },
        'kumbha': { 
            name: 'рдХреБрдореНрдн', english: 'Aquarius', lord: 'рд╢рдирд┐', element: 'рд╡рд╛рдпреБ', 
            nature: 'рд╕реНрдерд┐рд░', luckyColor: 'рдЖрд╕рдорд╛рдиреА', mantra: 'реР рд╢рдиреИрд╢реНрдЪрд░рд╛рдп рдирдордГ',
            bodyPart: 'рдкрд┐рдВрдбрд▓рд┐рдпрд╛рдВ', gemstone: 'рдиреАрд▓рдо', metal: 'рд▓реЛрд╣рд╛',
            personality: 'рдирд╡рд╛рдЪрд╛рд░реА, рдорд╛рдирд╡рддрд╛рд╡рд╛рджреА, рд╕реНрд╡рддрдВрддреНрд░ рд╡рд┐рдЪрд╛рд░рдХ', 
            strengths: 'рдкреНрд░рдЧрддрд┐рд╢реАрд▓, рджреЛрд╕реНрдд рдмрдирд╛рдиреЗ рдореЗрдВ рдорд╛рд╣рд┐рд░, рдЕрдиреЛрдЦреЗ рд╡рд┐рдЪрд╛рд░',
            challenges: 'рд╡рд┐рджреНрд░реЛрд╣реА, рднрд╛рд╡рдирд╛рд░рд╣рд┐рдд, рдЕрдкреНрд░рддреНрдпрд╛рд╢рд┐рдд',
            lifeLesson: 'рднрд╛рд╡рдирд╛рддреНрдордХ рдЬреБрдбрд╝рд╛рд╡ рдФрд░ рдкреНрд░рддрд┐рдмрджреНрдзрддрд╛',
            direction: 'рдкрд╢реНрдЪрд┐рдо',
            luckyDay: 'рд╢рдирд┐рд╡рд╛рд░',
            luckyNumbers: [4, 8, 13, 22, 31],
            deity: 'рднрдЧрд╡рд╛рди рд╢рд┐рд╡',
            symbol: 'тЩТ'
        },
        'meena': { 
            name: 'рдореАрди', english: 'Pisces', lord: 'рдмреГрд╣рд╕реНрдкрддрд┐', element: 'рдЬрд▓', 
            nature: 'рджреНрд╡рд┐рд╕реНрд╡рднрд╛рд╡', luckyColor: 'рдкреАрд▓рд╛', mantra: 'реР рдмреГрд╣рд╕реНрдкрддрдпреЗ рдирдордГ',
            bodyPart: 'рдкреИрд░', gemstone: 'рдкреБрдЦрд░рд╛рдЬ', metal: 'рд╕реЛрдирд╛',
            personality: 'рдХрд▓реНрдкрдирд╛рд╢реАрд▓, рдХрд░реБрдгрд╛рд╢реАрд▓, рдЖрдзреНрдпрд╛рддреНрдорд┐рдХ', 
            strengths: 'рд╕рд╣рд╛рдиреБрднреВрддрд┐рд╢реАрд▓, рдХрд▓рд╛рддреНрдордХ, рдЕрдВрддрд░реНрдЬреНрдЮрд╛рдиреА',
            challenges: 'рднреНрд░рдорд┐рдд, рдЕрддрд┐рд╕рдВрд╡реЗрджрдирд╢реАрд▓, рдкрд▓рд╛рдпрдирд╡рд╛рджреА',
            lifeLesson: 'рд╡рд╛рд╕реНрддрд╡рд┐рдХрддрд╛ рд╕реЗ рдЬреБрдбрд╝рдирд╛ рдФрд░ рд╕реАрдорд╛рдПрдВ рдмрдирд╛рдирд╛',
            direction: 'рдЙрддреНрддрд░',
            luckyDay: 'рдЧреБрд░реБрд╡рд╛рд░',
            luckyNumbers: [3, 9, 12, 21, 30],
            deity: 'рднрдЧрд╡рд╛рди рд╡рд┐рд╖реНрдгреБ',
            symbol: 'тЩУ'
        }
    };
    
    return vedicRashis[zodiacSign] || vedicRashis['mesha'];
};


        const rashiInfo = getVedicRashiInfo(zodiacSign);

        // ЁЯМЯ VEDIC PRACTICAL WISDOM PROMPT (Like ContentGenerator Style)
        const getVedicPracticalPrompt = (name, rashiInfo, gender, language, today) => {
            const basePrompt = `
ЁЯХЙя╕П рдЖрдЬ рдХрд╛ рджрд┐рдирд╛рдВрдХ: ${today.hindi}
ЁЯУЕ English Date: ${today.english}  
тП░ рд╡рд░реНрддрдорд╛рди рд╕рдордп: ${today.time}

рд╡реНрдпрдХреНрддрд┐: ${name} (${gender === 'male' ? 'рдкреБрд░реБрд╖' : 'рдорд╣рд┐рд▓рд╛'})
рд░рд╛рд╢рд┐: ${rashiInfo.name} (${rashiInfo.english})
рд░рд╛рд╢рд┐ рд╕реНрд╡рд╛рдореА: ${rashiInfo.lord}
рддрддреНрд╡: ${rashiInfo.element}
рд╕реНрд╡рднрд╛рд╡: ${rashiInfo.nature}
рд╢рд░реАрд░ рднрд╛рдЧ: ${rashiInfo.bodyPart}
рд░рддреНрди: ${rashiInfo.gemstone}
рдордВрддреНрд░: ${rashiInfo.mantra}

UNIQUE APPROACH - PRACTICAL VEDIC WISDOM:
Like Hanuman bringing the Sanjeevani mountain (representing abundant healing solutions, not literal mountain), explain astrological guidance through practical applications that modern people can actually use in their daily life.

You are a wise Vedic astrologer combining ancient Sanskrit wisdom with practical modern life guidance. 

SEARCH REQUIREMENT: 
Search for current planetary transits happening TODAY (${today.english}) that specifically affect ${rashiInfo.name} рд░рд╛рд╢рд┐. Find real astronomical data about planet positions, lunar phase, and astrological transits occurring today.

CURRENT COSMIC CONTEXT:
- Today's Date: ${today.english}
- Rashi: ${rashiInfo.name} (ruled by ${rashiInfo.lord})
- Element: ${rashiInfo.element}
- Person: ${name} (${gender})
- Personality Traits: ${rashiInfo.personality}
- Core Strengths: ${rashiInfo.strengths}
- Life Challenges: ${rashiInfo.challenges}
- Life Lesson: ${rashiInfo.lifeLesson}

WRITING STYLE - PRACTICAL VEDIC APPROACH:
- Use stories from Ramayana/Mahabharata to illustrate points
- Explain WHY astrological influences work psychologically
- Provide actionable, specific advice for TODAY
- Avoid superstitious language, focus on practical wisdom
- Address ${name} directly throughout
- Connect ancient wisdom to modern situations

CONTENT STRUCTURE for ${name} рдЬреА (800-1000 words in ${language === 'hindi' ? 'Hindi' : 'English'}):

## ЁЯМЕ ${name} рдЬреА, рдЖрдЬ рдХрд╛ рд╡рд┐рд╢реЗрд╖ рдХреЙрд╕реНрдорд┐рдХ рд╕рдВрджреЗрд╢ (150 words)
- Current planetary positions affecting ${rashiInfo.name} рд░рд╛рд╢рд┐ TODAY
- What this means for ${name} personally
- Ancient wisdom connection (like Krishna's guidance in Gita)

## ЁЯТл рдЖрдЬ рдХреА рд╡реНрдпрдХреНрддрд┐рдЧрдд рдКрд░реНрдЬрд╛ рдЧрд╛рдЗрдб (200 words)  
- How ${name}'s ${rashiInfo.element} element is activated today
- Practical advice for managing energy levels
- Connection to ${rashiInfo.lord} planet's influence
- Real-world applications (work, relationships, health)

## ЁЯПа рдЬреАрд╡рди рдХреЗ рд╡рд┐рднрд┐рдиреНрди рдХреНрд╖реЗрддреНрд░реЛрдВ рдореЗрдВ рдЖрдЬ рдХреА рд╕рд▓рд╛рд╣ (300 words)
- Career/Work: Specific guidance for ${name}'s profession
- Relationships: How to handle interactions today
- Health: Based on ${rashiInfo.bodyPart} body part connection
- Finances: Practical money decisions for today

## ЁЯУЪ рдкреНрд░рд╛рдЪреАрди рдХрд╣рд╛рдиреА рд╕реЗ рдЖрдзреБрдирд┐рдХ рд╕реАрдЦ (200 words)
- Relevant story from epics that applies to ${name}'s situation
- How ancient characters dealt with similar challenges
- Modern psychological interpretation
- Practical implementation in today's context

## ЁЯОп ${name} рдЬреА рдХреЗ рд▓рд┐рдП рдЖрдЬ рдХреЗ рд╡реНрдпрд╛рд╡рд╣рд╛рд░рд┐рдХ рдЙрдкрд╛рдп (150 words)
- Specific mantra: ${rashiInfo.mantra} (with practical benefits)
- Lucky color: ${rashiInfo.luckyColor} (how to use it)
- Best timing for important activities today
- Simple actions that align with cosmic energy

TONE: Wise but accessible, like a knowledgeable friend who understands both ancient wisdom and modern life
LANGUAGE: ${language === 'hindi' ? 'Clear Hindi with Sanskrit terms explained' : 'Professional English with Sanskrit terms'}
FOCUS: Practical wisdom that ${name} can actually use TODAY

Search for real planetary data for TODAY and create ${name} рдЬреА's personalized practical Vedic guidance:`;

            return basePrompt;
        };

        const prompt = getVedicPracticalPrompt(name, rashiInfo, gender, language, today);

        // Make request to Perplexity API for real-time cosmic data
        const response = await fetch('https://api.perplexity.ai/chat/completions', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${PERPLEXITY_API_KEY}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                model: 'sonar', // Uses web search for current planetary positions
                messages: [
                    {
                        role: 'user',
                        content: prompt
                    }
                ],
                max_tokens: 1500,
                temperature: 0.8,
                top_p: 0.9,
                stream: false
            })
        });

        if (!response.ok) {
            const errorText = await response.text();
            console.error('Perplexity API Response:', response.status, errorText);
            throw new Error(`Perplexity API error: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();
        let content = data.choices[0].message.content;
        
        // Enhanced formatting for Vedic content
        const formattedContent = content
            .replace(/\*\*(.*?)\*\*/g, '<strong class="text-orange-800 font-bold">$1</strong>')
            .replace(/\*(.*?)\*/g, '<em class="text-orange-700">$1</em>')
            .replace(/#{3}\s*(.*?)$/gm, '<h3 class="text-xl font-bold text-orange-800 mt-6 mb-3 flex items-center"><span class="mr-2">ЁЯМЯ</span>$1</h3>')
            .replace(/#{2}\s*(.*?)$/gm, '<h2 class="text-2xl font-bold text-orange-800 mt-8 mb-4 flex items-center"><span class="mr-2">тЬи</span>$1</h2>')
            .replace(/#{1}\s*(.*?)$/gm, '<h1 class="text-3xl font-bold text-orange-800 mt-10 mb-6 flex items-center"><span class="mr-2">ЁЯХЙя╕П</span>$1</h1>')
            .replace(/\n\n/g, '</p><p class="mb-4 leading-relaxed text-gray-800">')
            .replace(/^(.*)$/gm, '<p class="mb-4 leading-relaxed text-gray-800">$1</p>')
            .replace(/<p class="mb-4 leading-relaxed text-gray-800"><\/p>/g, '')
            .replace(/<p class="mb-4 leading-relaxed text-gray-800"><h/g, '<h')
            .replace(/<\/h([1-6])><\/p>/g, '</h$1>')
            // Add special formatting for mantras
            .replace(/(реР [^ред]+ред?)/g, '<span class="sanskrit-text text-orange-900 font-bold bg-yellow-100 px-2 py-1 rounded">$1</span>');

        res.json({
            success: true,
            content: formattedContent,
            metadata: {
                personName: name,
                zodiacSign: rashiInfo.name,
                zodiacLord: rashiInfo.lord,
                element: rashiInfo.element,
                language: language,
                todaysDate: today.hindi,
                englishDate: today.english,
                currentTime: today.time,
                weekday: today.weekday,
                predictionType: 'Practical Vedic Wisdom',
                contentStrategy: 'Ancient wisdom meets modern practical guidance',
                generatedAt: new Date().toISOString(),
                source: 'Vedic AI with Real-Time Planetary Data + Practical Psychology',
                searchType: 'Real-time cosmic events with practical applications',
                rashiTraits: {
                    personality: rashiInfo.personality,
                    strengths: rashiInfo.strengths,
                    challenges: rashiInfo.challenges,
                    lifeLesson: rashiInfo.lifeLesson
                }
            }
        });

    } catch (error) {
        console.error('Vedic practical wisdom generation error:', error);
        res.status(500).json({
            success: false,
            message: language === 'hindi' 
                ? 'рдЖрдЬ рдХреА рд╡реНрдпрд╛рд╡рд╣рд╛рд░рд┐рдХ рд╕рд▓рд╛рд╣ рдмрдирд╛рдиреЗ рдореЗрдВ рд╕рдорд╕реНрдпрд╛ рд╣реБрдИред рдХреГрдкрдпрд╛ рдлрд┐рд░ рд╕реЗ рдХреЛрд╢рд┐рд╢ рдХрд░реЗрдВред'
                : 'Failed to generate practical Vedic guidance. Please try again.',
            error: process.env.NODE_ENV === 'development' ? error.message : undefined
        });
    }
});

module.exports = router;
